C51 COMPILER V9.05   STC15W408AS                                                           10/13/2016 19:48:32 PAGE 1   


C51 COMPILER V9.05, COMPILATION OF MODULE STC15W408AS
OBJECT MODULE PLACED IN STC15W408AS.OBJ
COMPILER INVOKED BY: d:\Keil\C51\BIN\C51.EXE STC15W408AS.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          //-------------------------------------------
   2          //-STC15W408AS项目主程序
   3          //-------------------------------------------
   4          //项目注释添加时间：2014年11月13日
   5          
   6          #include "reg51.h"
   7          #include "shumashow.h"  //数码管显示模块调用
   8          
   9          
  10          //P2端口引脚模式配置定义
  11          sfr P2M1=0x95;
  12          sfr P2M0=0x96;
  13          //P2M1.n P2M0.n
  14          //00->standard 01->push-pull
  15          //10->pure input 11->open drain
  16          
  17          //按键接口定义
  18          sbit key1= P3^2;
  19          sbit key2= P3^3;
  20          
  21          //led接口定义
  22          sbit led1= P2^3;
  23          sbit led2= P2^2;
  24          sbit led3= P2^1;
  25          
  26          //继电器接口定义
  27          sbit relay= P2^0;
  28          
  29          //定时器模式设置寄存器定义
  30          sfr AUXR = 0x8e;                    //Auxiliary register
  31          
  32          
  33          
  34          //定时器0 延时5ms
  35          void TimerInit(void)
  36          {
  37   1              AUXR |= 0x80;           //定时器时钟1T模式
  38   1              TMOD &= 0xF0;           //设置定时器模式
  39   1              TL0 = 0xA0;             //设置定时初值
  40   1              TH0 = 0x15;             //设置定时初值
  41   1              TF0 = 0;                //清除TF0标志
  42   1              TR0 = 0;                //定时器0不开始计时
  43   1      }
  44          
  45          //定时器开启
  46          void TimerStart(void)
  47          {
  48   1              AUXR |= 0x80;           //定时器时钟1T模式
  49   1              TMOD &= 0xF0;           //设置定时器模式
  50   1              TL0 = 0xA0;             //设置定时初值
  51   1              TH0 = 0x15;             //设置定时初值
  52   1              TR0 = 1;                        //定时器0开始计时
  53   1          ET0 = 1;                            //使能定时器0中断
  54   1          EA = 1;                                                     
  55   1      }
C51 COMPILER V9.05   STC15W408AS                                                           10/13/2016 19:48:32 PAGE 2   

  56          //定时器停止
  57          void TimerStop(void)
  58          {
  59   1              AUXR |= 0x80;           //定时器时钟1T模式
  60   1              TMOD &= 0xF0;           //设置定时器模式
  61   1              TL0 = 0xA0;             //设置定时初值
  62   1              TH0 = 0x15;             //设置定时初值                                  
  63   1              TR0 = 0;                        //定时器0开始计时
  64   1          ET0 = 0;                        //使能定时器0中断
  65   1          EA = 0;
  66   1      }
  67          //延时
  68          void delay(unsigned int x)
  69          {
  70   1              unsigned int i,j;
  71   1              for(i=0;i<x;i++)
  72   1              for(j=0;j<100;j++);
  73   1      }
  74          //继电器开启
  75          void relay_on()
  76          {
  77   1              relay=1;
  78   1      }
  79          //继电器关闭
  80          void relay_off()
  81          {
  82   1              relay=0;
  83   1      }
  84          //led1开启
  85          void led1_on()
  86          {
  87   1              led1=0;
  88   1      }
  89          //led1关闭
  90          void led1_off()
  91          {
  92   1              led1=1;
  93   1      }
  94          //led2开启
  95          void led2_on()
  96          {
  97   1              led2=0;
  98   1      }
  99          //led2关闭
 100          void led2_off()
 101          {
 102   1              led2=1;
 103   1      }
 104          //led3开启
 105          void led3_on()
 106          {
 107   1              led3=0;
 108   1      }
 109          //led3关闭
 110          void led3_off()
 111          {
 112   1              led3=1;
 113   1      }
 114          
 115          //-------------试用限制开关和计数变量-----------------------
 116          unsigned int use_cnt=0;         //试用限制变量 
 117          //#define USE_TEST      //试用开关 
C51 COMPILER V9.05   STC15W408AS                                                           10/13/2016 19:48:32 PAGE 3   

 118          //---------------------------------------------------------
 119          unsigned int RelayOnMin=0;      //继电器定时工作时间
 120          unsigned int RelayOrderMin=0;//继电器预约定时时间
 121          
 122          unsigned int OneSecondFlag=0;
 123          
 124          unsigned char System_Mode=0x01; //定时设置模式
 125                                                                                                                  //0x02;//预约设置模式
 126                                                                                                                  //0x03;//预约模式
 127                                                                                                                  //0x04//定时模式
 128          
 129          void RelayOnTimeSetMode(void);
 130          void RelayOrderTimeSetMode(void);
 131          void RelayOrderMode(void);
 132          void RelayOnMode(void);
 133          //主程序
 134          void main()
 135          {
 136   1              //系统初始化
 137   1              delay(10);      //开机延时
 138   1              
 139   1              P2M0=0x01;              //P20 推挽输出,继电器控制引脚
 140   1              P2M1=0x00;
 141   1              relay=0;        
 142   1              led1_off();
 143   1              led2_off();
 144   1              led3_off();
 145   1              TimerInit();   //5ms interrupt
 146   1              TimerStart();
 147   1              
 148   1              System_Mode=0x01;//默认进入定时设置模式
 149   1              while(1)
 150   1              {
 151   2                      if(System_Mode==0x01)//正常模式
 152   2                      {
 153   3                      //      NormalMode_Key_Scan();
 154   3                              RelayOnTimeSetMode();
 155   3                              ShuMaShow(RelayOnMin,10);
 156   3                      }
 157   2                      else if(System_Mode==0x02)//预约设置模式
 158   2                      {
 159   3                              RelayOrderTimeSetMode();
 160   3                      }
 161   2                      else if(System_Mode==0x03)//预约模式
 162   2                      {
 163   3                              RelayOrderMode();
 164   3                      }
 165   2                      else if(System_Mode==0x04)
 166   2                      {
 167   3                              RelayOnMode();
 168   3                      }
 169   2      
 170   2                      
 171   2              }       
 172   1      }
 173          
 174          /* Timer0 interrupt routine */
 175          void tm0_isr() interrupt 1 using 1
 176          {
 177   1              static unsigned int i=0;        //定时器静态变量，记录定时器中断次数，5ms计数一次
 178   1                      
 179   1              i++;
C51 COMPILER V9.05   STC15W408AS                                                           10/13/2016 19:48:32 PAGE 4   

 180   1              if(i>199)       //200次为1秒 200*5ms=1s
 181   1              {
 182   2                      i=0;    //重新置零
 183   2                      OneSecondFlag=1;
 184   2              }
 185   1      }
 186          void RelayOnTimeSetMode()
 187          {
 188   1              unsigned int i=30;
 189   1              
 190   1              led1=0;
 191   1              led2=led3=1;
 192   1              
 193   1              if(key1==0&&key2==0)
 194   1              {
 195   2                      delay(10);
 196   2                      if(key1==0&&key2==0)
 197   2                      {
 198   3                              System_Mode=0x02;//进入预约模式
 199   3                              while(key1==0||key2==0)
 200   3                              {
 201   4                                      led1=led2=led3=~led3;
 202   4                                              delay(1000);
 203   4                                      ShuMaShow(RelayOnMin,10);
 204   4                              }
 205   3                      }
 206   2                      if(System_Mode==0x02)
 207   2                              return;
 208   2              }
 209   1              
 210   1              if(key1==0)
 211   1              {
 212   2                      delay(10);
 213   2                      if(key1==0)
 214   2                      {
 215   3                              RelayOnMin+=1;
 216   3                              if(RelayOnMin>(99*60+59))
 217   3                                      RelayOnMin=0;
 218   3                      }
 219   2              }
 220   1              
 221   1              if(key2==0)
 222   1              {
 223   2                      delay(10);
 224   2                      if(key2==0)
 225   2                      {
 226   3                              if(RelayOnMin>0)
 227   3                                      RelayOnMin--;
 228   3                      }
 229   2              }
 230   1              
 231   1              while(i--)
 232   1              {
 233   2                      ShuMaShow(RelayOnMin,10);
 234   2              }
 235   1              
 236   1      }
 237          void RelayOrderTimeSetMode()
 238          {
 239   1              unsigned int i=30;
 240   1              
 241   1              led2=0;
C51 COMPILER V9.05   STC15W408AS                                                           10/13/2016 19:48:32 PAGE 5   

 242   1              led1=led3=1;
 243   1              
 244   1              if(key1==0&&key2==0)
 245   1              {
 246   2                      delay(10);
 247   2                      if(key1==0&&key2==0)
 248   2                      {
 249   3                              System_Mode=0x03;//进入预约模式
 250   3                              while(key1==0||key2==0)
 251   3                              {
 252   4                                      led1=led2=led3=~led3;
 253   4                                      ShuMaShow(RelayOrderMin,10);
 254   4                                      delay(1000);
 255   4                              }
 256   3                              
 257   3                      }
 258   2                      if(System_Mode==0x03)
 259   2                              return;
 260   2              }
 261   1              
 262   1              if(key1==0)
 263   1              {
 264   2                      delay(10);
 265   2                      if(key1==0)
 266   2                      {
 267   3                              RelayOrderMin+=1;
 268   3                              if(RelayOrderMin>(99*60+59))
 269   3                                      RelayOrderMin=0;
 270   3                      }
 271   2              }
 272   1              
 273   1              if(key2==0)
 274   1              {
 275   2                      delay(10);
 276   2                      if(key2==0)
 277   2                      {
 278   3                              if(RelayOrderMin>0)
 279   3                                      RelayOrderMin--;
 280   3                      }
 281   2              }
 282   1              
 283   1              while(i--)
 284   1              {
 285   2                      ShuMaShow(RelayOrderMin,10);
 286   2              }       
 287   1      }
 288          void RelayOrderMode()
 289          {
 290   1              static unsigned char TempSecond=0;
 291   1              led1=1;
 292   1              led2=0;
 293   1                      
 294   1              
 295   1              
 296   1              if(key1==0||key2==0)
 297   1              {
 298   2                      delay(10);
 299   2                      while(key1==0||key2==0)
 300   2                      {
 301   3                              RelayOrderMin=0;
 302   3                              RelayOnMin=0;
 303   3                              System_Mode=0x01;
C51 COMPILER V9.05   STC15W408AS                                                           10/13/2016 19:48:32 PAGE 6   

 304   3                              relay=0;
 305   3                      }
 306   2              }
 307   1                      
 308   1              if(OneSecondFlag)
 309   1              {
 310   2                      OneSecondFlag=0x00;
 311   2                      TempSecond++;
 312   2                      
 313   2                      if(RelayOrderMin==0)
 314   2                      {
 315   3                              System_Mode=0x04;
 316   3                              //relay=1;
 317   3                      }
 318   2                      
 319   2                      if(TempSecond==59)
 320   2                      {
 321   3                              TempSecond=0;
 322   3                              if(RelayOrderMin>0)
 323   3                              {
 324   4                                      RelayOrderMin--;
 325   4                              }
 326   3                              
 327   3                              if(RelayOrderMin==0)
 328   3                              {
 329   4                                      System_Mode=0x04;
 330   4                                      //relay=1;
 331   4                              }
 332   3                      }
 333   2                      led3=~led3;
 334   2              }
 335   1              ShuMaShow(RelayOrderMin,10);
 336   1      }
 337          
 338          void RelayOnMode()
 339          {
 340   1              static unsigned char TempSecond=0;
 341   1              led1=0;
 342   1              led2=1;
 343   1                              
 344   1                      if(key1==0||key2==0)
 345   1              {
 346   2                      delay(10);
 347   2                      while(key1==0||key2==0)
 348   2                      {
 349   3                              RelayOrderMin=0;
 350   3                              RelayOnMin=0;
 351   3                              System_Mode=0x01;
 352   3                              relay=0;
 353   3                      }
 354   2              }
 355   1              
 356   1              
 357   1              if(OneSecondFlag)
 358   1              {
 359   2                      OneSecondFlag=0x00;
 360   2                      
 361   2                      if(RelayOnMin==0)
 362   2                              {
 363   3                                      relay=0;
 364   3                                      System_Mode=0x01;
 365   3                              }
C51 COMPILER V9.05   STC15W408AS                                                           10/13/2016 19:48:32 PAGE 7   

 366   2                              else
 367   2                              {
 368   3                                      relay=1;
 369   3                              }
 370   2              
 371   2                      TempSecond++;
 372   2                      if(TempSecond==59)
 373   2                      {
 374   3                              TempSecond=0;
 375   3                              if(RelayOnMin>0)
 376   3                              {
 377   4                                      RelayOnMin--;
 378   4                              }
 379   3                              if(RelayOnMin==0)
 380   3                              {
 381   4                                      relay=0;
 382   4                                      System_Mode=0x01;
 383   4                              }
 384   3                      }
 385   2                      led3=~led3;
 386   2              }
 387   1              ShuMaShow(RelayOnMin,10);
 388   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    767    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     13       4
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
